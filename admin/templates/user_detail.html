{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{ user.username or user.tg_id }} - YoVPN Admin{% endblock %}
{% block page_title %}üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ user.username or user.tg_id }}{% endblock %}

{% block content %}
<!-- User Info Card -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Main Info -->
    <div class="lg:col-span-2">
        <div class="card">
            <h3 class="text-xl font-semibold mb-4">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-600">Telegram ID</p>
                    <p class="font-semibold">{{ user.tg_id }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-600">Username</p>
                    <p class="font-semibold">{{ user.username or "-" }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-600">–ò–º—è</p>
                    <p class="font-semibold">{{ user.first_name or "" }} {{ user.last_name or "" }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-600">–ë–∞–ª–∞–Ω—Å</p>
                    <p class="font-semibold text-green-600 text-lg">{{ user.balance|currency }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-600">–°—Ç–∞—Ç—É—Å</p>
                    {% if user.is_blocked %}
                        <span class="px-3 py-1 text-sm rounded-full bg-red-100 text-red-800">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                    {% else %}
                        <span class="px-3 py-1 text-sm rounded-full bg-green-100 text-green-800">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% endif %}
                </div>
                
                <div>
                    <p class="text-sm text-gray-600">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</p>
                    <p class="font-semibold">{{ user.referral_count }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-600">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
                    <p class="font-semibold">{{ user.created_at|datetime }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-600">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
                    <p class="font-semibold">{{ user.last_activity|datetime if user.last_activity else "-" }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div>
        <div class="card">
            <h3 class="text-xl font-semibold mb-4">‚ö° –î–µ–π—Å—Ç–≤–∏—è</h3>
            
            <div class="space-y-3">
                <!-- Block/Unblock -->
                {% if user.is_blocked %}
                <form method="POST" action="/admin/users/{{ user.id }}/unblock">
                    <button type="submit" class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        ‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </form>
                {% else %}
                <form method="POST" action="/admin/users/{{ user.id }}/block">
                    <button type="submit" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </form>
                {% endif %}
                
                <!-- Balance Form -->
                <form method="POST" action="/admin/users/{{ user.id }}/balance" class="space-y-2">
                    <input type="number" name="amount" step="0.01" placeholder="–°—É–º–º–∞ (+ –∏–ª–∏ -)" required
                           class="w-full px-3 py-2 border rounded-lg">
                    <input type="text" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
                           class="w-full px-3 py-2 border rounded-lg">
                    <button type="submit" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        üí∞ –ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
                    </button>
                </form>
                
                <!-- Delete -->
                <form method="POST" action="/admin/users/{{ user.id }}/delete" 
                      onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')">
                    <button type="submit" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Subscriptions -->
<div class="card mb-6">
    <h3 class="text-xl font-semibold mb-4">üõ∞Ô∏è –ü–æ–¥–ø–∏—Å–∫–∏ ({{ subscriptions|length }})</h3>
    
    {% if subscriptions %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marzban Username</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ù–∞—á–∞–ª–æ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for sub in subscriptions %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm">{{ sub.id }}</td>
                    <td class="px-6 py-4 text-sm font-mono">{{ sub.marzban_username }}</td>
                    <td class="px-6 py-4 text-sm">
                        {% if sub.is_active %}
                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">–ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% else %}
                            <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-sm">{{ sub.start_date|datetime }}</td>
                    <td class="px-6 py-4 text-sm">{{ sub.end_date|datetime if sub.end_date else "‚àû" }}</td>
                    <td class="px-6 py-4 text-sm">
                        <a href="/admin/subscriptions/{{ sub.id }}" class="text-blue-600 hover:underline">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-500 text-center py-4">–ü–æ–¥–ø–∏—Å–æ–∫ –Ω–µ—Ç</p>
    {% endif %}
</div>

<!-- Transactions -->
<div class="card">
    <h3 class="text-xl font-semibold mb-4">üí≥ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50)</h3>
    
    {% if transactions %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–î–∞—Ç–∞</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¢–∏–ø</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°—É–º–º–∞</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ë–∞–ª–∞–Ω—Å –¥–æ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for trans in transactions %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm">{{ trans.created_at|datetime }}</td>
                    <td class="px-6 py-4 text-sm">
                        {% if trans.type.value == 'deposit' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</span>
                        {% elif trans.type.value == 'withdraw' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">–°–ø–∏—Å–∞–Ω–∏–µ</span>
                        {% elif trans.type.value == 'bonus' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">–ë–æ–Ω—É—Å</span>
                        {% else %}
                            <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">{{ trans.type.value }}</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-sm font-semibold {% if trans.amount > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {{ trans.amount|currency }}
                    </td>
                    <td class="px-6 py-4 text-sm">{{ trans.balance_before|currency }}</td>
                    <td class="px-6 py-4 text-sm">{{ trans.balance_after|currency }}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">{{ trans.description or "-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-500 text-center py-4">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ—Ç</p>
    {% endif %}
</div>

<div class="mt-6">
    <a href="/admin/users" class="text-blue-600 hover:underline">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</a>
</div>
{% endblock %}
