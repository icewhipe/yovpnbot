# ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° YoVPN Ğ½Ğ° Railway

## ğŸ“Š ĞĞ±Ñ‰Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         RAILWAY PLATFORM                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Redis DB   â”‚    â”‚ Telegram Bot â”‚    â”‚      API     â”‚      â”‚
â”‚  â”‚              â”‚â—„â”€â”€â”€â”¤              â”‚    â”‚   Backend    â”‚      â”‚
â”‚  â”‚ Port: 6379   â”‚    â”‚ Python 3.11  â”‚    â”‚  FastAPI     â”‚      â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â–²                   â”‚                    â”‚              â”‚
â”‚         â”‚                   â”‚                    â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                             â”‚                    â”‚              â”‚
â”‚                             â”‚              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                             â”‚              â”‚   WebApp   â”‚       â”‚
â”‚                             â”‚              â”‚  Next.js   â”‚       â”‚
â”‚                             â”‚              â”‚ Port: 3000 â”‚       â”‚
â”‚                             â”‚              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                             â”‚                    â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                    â”‚
                              â–¼                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Telegram Users  â”‚  â”‚  Browser Users   â”‚
                    â”‚   (Bot Chat)     â”‚  â”‚  (WebApp URL)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Marzban Server  â”‚
                              â”‚  (External VPN)  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼

```
User â†’ Telegram â†’ Bot Service â†’ Redis (ĞºÑÑˆ) â†’ Marzban API
                       â†“
                User Service
                       â†“
              Payment Service
```

### 2. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ WebApp

```
User â†’ WebApp URL â†’ Next.js Server â†’ API Backend â†’ Marzban
                         â†“
                   React Components
                         â†“
                 Telegram WebApp SDK
```

### 3. ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸

```
User clicks "Activate"
      â†“
WebApp â†’ API â†’ Marzban â†’ Create User â†’ Return Config
      â†“
WebApp displays QR Code + Connection Details
      â†“
User connects to VPN
```

## ğŸš€ Railway Services

### 1ï¸âƒ£ Redis Service
- **Type**: Database
- **Image**: `redis:7-alpine`
- **Port**: 6379 (internal)
- **Purpose**: ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, rate limiting
- **Storage**: In-memory + persistence
- **URL**: `${{Redis.REDIS_URL}}`

### 2ï¸âƒ£ Telegram Bot Service
- **Type**: Python Application
- **Runtime**: Python 3.11
- **Framework**: Aiogram 3.4
- **Port**: ĞĞµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ (long polling)
- **Start Command**: `python bot/main.py`
- **Dockerfile**: `/Dockerfile`
- **Dependencies**:
  - Redis (ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
  - Marzban API (ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ VPN)

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸**:
- ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°Ğ¼Ğ¸
- ĞŸÑ€Ğ¸ĞµĞ¼ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹
- Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
- ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ

### 3ï¸âƒ£ API Backend Service
- **Type**: Python API
- **Runtime**: Python 3.11
- **Framework**: FastAPI
- **Port**: `$PORT` (auto-assigned)
- **Root Directory**: `api`
- **Start Command**: `uvicorn app.main:app --host 0.0.0.0 --port $PORT`
- **Public URL**: âœ… Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ (Generate Domain)
- **Health Check**: `/health`

**Endpoints**:
- `GET /api/health` - Health check
- `GET /api/subscriptions/{user_id}` - Get user subscription
- `POST /api/activate` - Activate subscription
- `GET /docs` - API Documentation (Swagger)

### 4ï¸âƒ£ WebApp Frontend Service
- **Type**: Next.js Application
- **Runtime**: Node.js 18
- **Framework**: Next.js 15
- **Port**: 3000
- **Root Directory**: `webapp`
- **Build**: `npm install && npm run build`
- **Start Command**: `npm start`
- **Public URL**: âœ… Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ (Generate Domain)
- **Output Mode**: Standalone (Docker)

**Features**:
- React 18 + TypeScript
- Tailwind CSS styling
- GSAP animations
- Telegram WebApp SDK
- PWA support

## ğŸ” Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

```
Ğ¡ĞµĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ (Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹):
â”œâ”€â”€ TELEGRAM_BOT_TOKEN (ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹)
â”œâ”€â”€ SECRET_KEY (ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹)
â”œâ”€â”€ MARZBAN_PASSWORD (ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹)
â””â”€â”€ REDIS_URL (Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹)

ĞŸÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ:
â”œâ”€â”€ NEXT_PUBLIC_API_BASE_URL
â”œâ”€â”€ NEXT_PUBLIC_BASE_URL
â””â”€â”€ NEXT_PUBLIC_TELEGRAM_BOT_TOKEN
```

### Ğ¡ĞµÑ‚ĞµĞ²Ğ°Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

```
Railway Network:
â”œâ”€â”€ Internal Network (services communicate)
â”‚   â”œâ”€â”€ Bot â†” Redis (private)
â”‚   â””â”€â”€ API â†” Redis (private)
â”‚
â”œâ”€â”€ External Access (via HTTPS)
â”‚   â”œâ”€â”€ API (public domain)
â”‚   â””â”€â”€ WebApp (public domain)
â”‚
â””â”€â”€ CORS Protection
    â””â”€â”€ API allows only WebApp domain
```

### Rate Limiting

```
Bot:
â”œâ”€â”€ Per user: 10 requests/minute
â””â”€â”€ Global: 1000 requests/minute

API:
â”œâ”€â”€ Per IP: 100 requests/minute
â””â”€â”€ Per endpoint: varies
```

## ğŸ’¾ Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### SQLite Database (Bot)
```
data/bot.db
â”œâ”€â”€ users (user_id, telegram_id, username)
â”œâ”€â”€ subscriptions (user_id, status, expires_at)
â”œâ”€â”€ payments (user_id, amount, timestamp)
â””â”€â”€ admin_logs (action, timestamp)
```

### Redis Cache
```
redis:
â”œâ”€â”€ user:{user_id} (user data, TTL: 1h)
â”œâ”€â”€ subscription:{user_id} (subscription info, TTL: 5m)
â”œâ”€â”€ rate_limit:{user_id} (request counter, TTL: 1m)
â””â”€â”€ marzban_token (API token, TTL: 1h)
```

## ğŸ“Š ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Railway Resources

```
Free Tier:
â”œâ”€â”€ Memory: 512MB per service
â”œâ”€â”€ CPU: Shared
â”œâ”€â”€ Storage: 1GB
â””â”€â”€ Credits: $5/month

Pro Tier:
â”œâ”€â”€ Memory: 8GB per service
â”œâ”€â”€ CPU: Dedicated
â”œâ”€â”€ Storage: 100GB
â””â”€â”€ Pay as you go
```

### Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸

```
Development:
â””â”€â”€ Free tier (Ğ²ÑĞµ 4 ÑĞµÑ€Ğ²Ğ¸ÑĞ°)

Production (< 1000 users):
â”œâ”€â”€ Bot: 512MB (Free)
â”œâ”€â”€ API: 512MB (Free)
â”œâ”€â”€ WebApp: 512MB (Free)
â””â”€â”€ Redis: Upgraded (Pro)

Production (> 1000 users):
â”œâ”€â”€ Bot: 1GB (Pro)
â”œâ”€â”€ API: 2GB (Pro)
â”œâ”€â”€ WebApp: 1GB (Pro)
â””â”€â”€ Redis: 2GB (Pro)
```

## ğŸ”„ CI/CD Pipeline

```
Developer â†’ Git Push â†’ GitHub
                          â†“
                    Railway Webhook
                          â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                       â–¼
        Build Services         Run Tests
              â†“                       â†“
        Deploy Services        Health Check
              â†“                       â†“
        Generate URLs          Update DNS
              â†“                       â†“
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                  Production Live
```

## ğŸŒ Domain Configuration

### Railway Domains (Automatic)

```
Bot Service:
â””â”€â”€ No public URL needed

API Service:
â””â”€â”€ api-production-xxxx.up.railway.app

WebApp Service:
â””â”€â”€ webapp-production-xxxx.up.railway.app
```

### Custom Domains (Optional)

```
Your Domain â†’ DNS Provider
                    â†“
            CNAME Records
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                        â–¼
api.yourdomain.com    app.yourdomain.com
        â”‚                        â”‚
        â–¼                        â–¼
    API Service            WebApp Service
```

## ğŸ“ˆ ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

### Built-in Metrics (Railway)

```
Per Service:
â”œâ”€â”€ CPU Usage
â”œâ”€â”€ Memory Usage
â”œâ”€â”€ Network I/O
â”œâ”€â”€ Deployment History
â””â”€â”€ Logs (real-time)
```

### External Monitoring (Recommended)

```
UptimeRobot:
â”œâ”€â”€ API Health: /health (5 min interval)
â””â”€â”€ WebApp: / (5 min interval)

Sentry (Error Tracking):
â”œâ”€â”€ Bot errors
â”œâ”€â”€ API errors
â””â”€â”€ WebApp errors

Analytics:
â””â”€â”€ WebApp: Vercel Analytics or Google Analytics
```

## ğŸ”§ ĞĞ±ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ

### ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°

```
1. Push to GitHub
2. Railway auto-deploys
3. Zero-downtime deployment
4. Health check passes
5. Traffic switches to new version
```

### Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

```
ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸:
â””â”€â”€ Railway Database Snapshots (Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ñ… Ğ¿Ğ»Ğ°Ğ½Ğ¾Ğ²)

Ğ’Ñ€ÑƒÑ‡Ğ½ÑƒÑ:
â”œâ”€â”€ Export SQLite: scp bot.db local
â””â”€â”€ Export Redis: SAVE command
```

## ğŸ¯ Best Practices

### 1. Environment Variables
- âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ `${{Service.VAR}}` Ğ´Ğ»Ñ ÑĞ²ÑĞ·Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸
- âœ… ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ÑŒÑ‚Ğµ ÑĞµĞºÑ€ĞµÑ‚Ñ‹ Ğ² Git
- âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Railway Secrets Ğ´Ğ»Ñ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 2. Logging
- âœ… Structured logging (JSON format)
- âœ… Log levels: DEBUG, INFO, WARNING, ERROR
- âœ… Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ timestamp Ğ¸ context

### 3. Error Handling
- âœ… Graceful degradation
- âœ… Retry logic Ğ´Ğ»Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… API
- âœ… User-friendly error messages

### 4. Performance
- âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Redis Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ CDN Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¸ (Cloudflare)
- âœ… ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
- âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ connection pooling

### 5. Security
- âœ… HTTPS everywhere
- âœ… Validate all inputs
- âœ… Rate limiting
- âœ… CORS configuration
- âœ… Regular dependency updates

---

## ğŸ“š Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ€ĞµÑÑƒÑ€ÑÑ‹

- [Railway Documentation](https://docs.railway.app/)
- [Aiogram Documentation](https://docs.aiogram.dev/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Next.js Documentation](https://nextjs.org/docs)
- [Telegram Bot API](https://core.telegram.org/bots/api)

---

**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°:** 21.10.2025
