# 🚀 Полное руководство по развертыванию YoVPN Bot на Railway

## 📋 Содержание

1. [Введение](#введение)
2. [Что будет развернуто](#что-будет-развернуто)
3. [Подготовка к развертыванию](#подготовка-к-развертыванию)
4. [Шаг 1: Регистрация на Railway](#шаг-1-регистрация-на-railway)
5. [Шаг 2: Создание проекта](#шаг-2-создание-проекта)
6. [Шаг 3: Развертывание базы данных MySQL](#шаг-3-развертывание-базы-данных-mysql)
7. [Шаг 4: Развертывание Redis (опционально)](#шаг-4-развертывание-redis-опционально)
8. [Шаг 5: Развертывание Telegram бота](#шаг-5-развертывание-telegram-бота)
9. [Шаг 6: Развертывание админ-панели](#шаг-6-развертывание-админ-панели)
10. [Шаг 7: Применение миграций базы данных](#шаг-7-применение-миграций-базы-данных)
11. [Шаг 8: Проверка работоспособности](#шаг-8-проверка-работоспособности)
12. [Настройка после развертывания](#настройка-после-развертывания)
13. [Управление и мониторинг](#управление-и-мониторинг)
14. [Обновление приложения](#обновление-приложения)
15. [Устранение неполадок](#устранение-неполадок)
16. [Безопасность](#безопасность)
17. [Стоимость и оптимизация](#стоимость-и-оптимизация)

---

## Введение

Это пошаговое руководство поможет вам развернуть полнофункциональный VPN бот с админ-панелью на платформе Railway. После выполнения всех шагов у вас будет:

- ✅ **Telegram бот** для продажи VPN подписок
- ✅ **База данных MySQL** для хранения данных пользователей
- ✅ **Админ-панель** для управления ботом
- ✅ **Redis** для кэширования (опционально)
- ✅ **Автоматическое масштабирование** и мониторинг

**Время развертывания:** 30-40 минут  
**Уровень сложности:** Средний  
**Требуемые знания:** Базовые знания Telegram ботов

---

## Что будет развернуто

### Архитектура системы

```
┌─────────────────────────────────────────────────────┐
│                  Railway Project                     │
├─────────────────────────────────────────────────────┤
│                                                       │
│  ┌────────────┐  ┌────────────┐  ┌──────────────┐  │
│  │   MySQL    │  │   Redis    │  │ Telegram Bot │  │
│  │  Database  │  │   Cache    │  │   Service    │  │
│  └─────┬──────┘  └──────┬─────┘  └───────┬──────┘  │
│        │                │                 │          │
│        └────────────────┴─────────────────┘          │
│                         │                            │
│                  ┌──────┴─────────┐                  │
│                  │  Admin Panel   │                  │
│                  │   (FastAPI)    │                  │
│                  └────────────────┘                  │
│                         │                            │
└─────────────────────────┼────────────────────────────┘
                          │
                          ▼
                   Marzban VPN Server
                   (внешний сервер)
```

### Компоненты

1. **MySQL Database** - хранение данных пользователей, подписок, транзакций
2. **Redis Cache** - кэширование данных для быстрого доступа
3. **Telegram Bot** - основной бот для взаимодействия с пользователями
4. **Admin Panel** - веб-интерфейс для управления ботом (FastAPI + Jinja2)

---

## Подготовка к развертыванию

### 1. Создание Telegram бота

**Шаг 1:** Откройте [@BotFather](https://t.me/BotFather) в Telegram

**Шаг 2:** Отправьте команду `/newbot`

**Шаг 3:** Следуйте инструкциям:
```
BotFather: Alright, a new bot. How are we going to call it?
Вы: YoVPN Bot

BotFather: Good. Now let's choose a username for your bot.
Вы: yovpn_example_bot
```

**Шаг 4:** Получите токен бота и сохраните его:
```
BotFather: Done! Your token is:
123456789:ABCdefGHIjklMNOpqrsTUVwxyz1234567890
```

**⚠️ ВАЖНО:** Храните токен в безопасности! Не публикуйте его в открытом виде.

### 2. Получение вашего Telegram ID

Telegram ID нужен для доступа к админ панели.

**Способ 1:** Через бота [@userinfobot](https://t.me/userinfobot)
- Отправьте `/start`
- Скопируйте ваш ID (например: `7610842643`)

**Способ 2:** Через бота [@getidsbot](https://t.me/getidsbot)
- Отправьте `/start`
- Получите ваш ID

### 3. Получение данных от Marzban

Вам понадобятся следующие данные от вашего Marzban сервера:

- **MARZBAN_API_URL** - URL вашего сервера (например: `https://marzban.example.com`)
- **MARZBAN_USERNAME** - имя администратора
- **MARZBAN_PASSWORD** - пароль администратора

**Как получить токен Marzban:**

1. Откройте панель Marzban в браузере
2. Войдите под учетной записью администратора
3. Откройте Developer Tools (F12)
4. Перейдите в Network → выполните любое действие
5. Найдите заголовок `Authorization: Bearer ...`
6. Скопируйте токен (строка после `Bearer `)

**Альтернатива:** Вы можете использовать username/password вместо токена.

### 4. Генерация SECRET_KEY

SECRET_KEY используется для шифрования данных.

**Linux/Mac:**
```bash
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

**Windows (PowerShell):**
```powershell
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

**Онлайн:** https://www.random.org/strings/ (длина: 32 символа)

Сохраните полученный ключ, он понадобится позже.

### 5. Подготовка GitHub репозитория

**Если у вас уже есть форк проекта:**
- Убедитесь, что он синхронизирован с основным репозиторием

**Если нет:**
1. Перейдите на GitHub: https://github.com/yourusername/yovpn-bot
2. Нажмите **Fork** в правом верхнем углу
3. Дождитесь создания форка

---

## Шаг 1: Регистрация на Railway

### 1.1 Создание аккаунта

1. Откройте [railway.app](https://railway.app)
2. Нажмите **"Start a New Project"** или **"Login"**
3. Выберите **"Login with GitHub"**
4. Авторизуйте Railway в GitHub
5. Подтвердите email (если требуется)

### 1.2 Получение бесплатных кредитов

Railway предоставляет:
- **$5 бесплатно** каждый месяц на Hobby Plan
- **Без кредитной карты** для начала работы

**Важно:** После израсходования $5 сервисы остановятся до следующего месяца или обновления плана.

---

## Шаг 2: Создание проекта

### 2.1 Создание нового проекта

1. На главной странице Railway нажмите **"+ New Project"**
2. Выберите **"Deploy from GitHub repo"**
3. Если это первый раз, Railway запросит доступ к вашим репозиториям
4. Нажмите **"Configure GitHub App"**
5. Выберите репозиторий `yovpn-bot`
6. Нажмите **"Install & Authorize"**

### 2.2 Начальная настройка проекта

После выбора репозитория:
1. Railway автоматически создаст проект
2. Вы увидите начальную настройку сервиса
3. **НЕ НАЖИМАЙТЕ** "Deploy Now" пока - сначала настроим базу данных

### 2.3 Переименование проекта

Для удобства переименуйте проект:
1. Нажмите на название проекта вверху страницы
2. Введите новое имя, например: `yovpn-production`
3. Нажмите Enter

---

## Шаг 3: Развертывание базы данных MySQL

### 3.1 Добавление MySQL сервиса

1. В вашем проекте нажмите **"+ New"**
2. Выберите **"Database"**
3. Выберите **"Add MySQL"**
4. Railway автоматически создаст и запустит MySQL сервер

### 3.2 Настройка MySQL

1. Нажмите на созданный MySQL сервис
2. Перейдите во вкладку **"Variables"**
3. Railway автоматически создаст следующие переменные:
   - `MYSQL_ROOT_PASSWORD` - пароль root
   - `MYSQL_DATABASE` - имя базы данных
   - `MYSQL_USER` - имя пользователя
   - `MYSQL_PASSWORD` - пароль пользователя
   - `MYSQL_URL` - полный URL подключения
   - `DATABASE_URL` - алиас для `MYSQL_URL`

### 3.3 Проверка подключения

1. Перейдите во вкладку **"Deployments"**
2. Убедитесь, что статус **"Success"** и сервис показывает **"Active"**
3. MySQL теперь доступен внутри проекта Railway

### 3.4 Получение URL базы данных

URL базы данных будет в формате:
```
mysql://root:password@containers-us-west-123.railway.app:6543/railway
```

Этот URL автоматически доступен как переменная `${{MySQL.DATABASE_URL}}`

---

## Шаг 4: Развертывание Redis (опционально)

Redis используется для кэширования данных и улучшения производительности.

### 4.1 Добавление Redis сервиса

1. В вашем проекте нажмите **"+ New"**
2. Выберите **"Database"**
3. Выберите **"Add Redis"**
4. Railway автоматически создаст и запустит Redis сервер

### 4.2 Настройка Redis

Railway автоматически создаст переменные:
- `REDIS_URL` - URL подключения к Redis
- `REDIS_PRIVATE_URL` - приватный URL

Redis URL будет в формате:
```
redis://default:password@containers-us-west-123.railway.app:6543
```

**Примечание:** Redis не обязателен, но рекомендуется для production.

---

## Шаг 5: Развертывание Telegram бота

### 5.1 Создание сервиса для бота

1. В проекте нажмите **"+ New"**
2. Выберите **"GitHub Repo"**
3. Выберите репозиторий `yovpn-bot` (если он еще не добавлен)
4. Railway создаст новый сервис

### 5.2 Настройка бота

#### Шаг 1: Переименование сервиса

1. Нажмите на созданный сервис
2. В настройках (Settings) найдите **"Service Name"**
3. Переименуйте в `telegram-bot`

#### Шаг 2: Настройка команды запуска

1. Перейдите в **Settings** → **Deploy**
2. Найдите **"Custom Start Command"**
3. Введите:
   ```bash
   python -u bot/main.py
   ```

#### Шаг 3: Настройка переменных окружения

1. Перейдите во вкладку **"Variables"**
2. Нажмите **"+ New Variable"**
3. Добавьте следующие переменные:

**Обязательные переменные:**

| Переменная | Значение | Описание |
|-----------|----------|----------|
| `TELEGRAM_BOT_TOKEN` | `123456789:ABCdef...` | Токен от BotFather |
| `ADMIN_TG_ID` | `7610842643` | Ваш Telegram ID |
| `SECRET_KEY` | `ваш_сгенерированный_ключ` | Секретный ключ (32+ символа) |
| `DATABASE_URL` | `${{MySQL.DATABASE_URL}}` | Ссылка на MySQL |
| `MARZBAN_API_URL` | `https://your-marzban.com` | URL Marzban сервера |
| `MARZBAN_USERNAME` | `admin` | Логин администратора Marzban |
| `MARZBAN_PASSWORD` | `your_password` | Пароль администратора Marzban |

**Опциональные переменные:**

| Переменная | Значение | Описание |
|-----------|----------|----------|
| `REDIS_URL` | `${{Redis.REDIS_URL}}` | Ссылка на Redis (если добавлен) |
| `PYTHONUNBUFFERED` | `1` | Отключение буферизации вывода |
| `PYTHONDONTWRITEBYTECODE` | `1` | Отключение создания .pyc файлов |
| `DEBUG` | `False` | Режим отладки |
| `LOG_LEVEL` | `INFO` | Уровень логирования |

**Экономические настройки:**

| Переменная | Значение по умолчанию | Описание |
|-----------|----------------------|----------|
| `DAILY_PRICE` | `4.0` | Цена за день в рублях |
| `WELCOME_BONUS` | `12.0` | Приветственный бонус (3 дня) |
| `REFERRAL_BONUS` | `8.0` | Реферальный бонус (2 дня) |
| `MIN_DEPOSIT` | `40.0` | Минимальное пополнение (10 дней) |

**Контакты поддержки:**

| Переменная | Значение | Описание |
|-----------|----------|----------|
| `SUPPORT_USERNAME` | `@YoVPNSupport` | Username поддержки |
| `CHANNEL_USERNAME` | `@yodevelop` | Username канала |

#### Шаг 4: Настройка ссылок на другие сервисы

Для использования переменных из других сервисов:

```bash
# Ссылка на MySQL
DATABASE_URL=${{MySQL.DATABASE_URL}}

# Ссылка на Redis
REDIS_URL=${{Redis.REDIS_URL}}
```

Railway автоматически подставит значения при запуске.

### 5.3 Запуск бота

1. После добавления всех переменных Railway автоматически запустит деплой
2. Перейдите во вкладку **"Deployments"**
3. Дождитесь статуса **"Success"**
4. Проверьте логи во вкладке **"Logs"**

Вы должны увидеть:
```
INFO - ✅ Бот запущен
INFO - ✅ База данных подключена
INFO - ✅ MarzbanService инициализирован
```

---

## Шаг 6: Развертывание админ-панели

### 6.1 Создание сервиса для админ-панели

Мы создадим отдельный сервис для админ-панели.

1. В проекте нажмите **"+ New"**
2. Выберите **"GitHub Repo"**
3. Выберите тот же репозиторий `yovpn-bot`
4. Railway создаст новый сервис

### 6.2 Настройка админ-панели

#### Шаг 1: Переименование сервиса

1. Нажмите на созданный сервис
2. Переименуйте в `admin-panel`

#### Шаг 2: Настройка команды запуска

1. Перейдите в **Settings** → **Deploy**
2. Найдите **"Custom Start Command"**
3. Введите:
   ```bash
   uvicorn admin.main:app --host 0.0.0.0 --port $PORT
   ```

**Важно:** `$PORT` - это переменная, которую Railway автоматически устанавливает.

#### Шаг 3: Настройка переменных окружения

1. Перейдите во вкладку **"Variables"**
2. Добавьте следующие переменные:

**Обязательные переменные:**

| Переменная | Значение | Описание |
|-----------|----------|----------|
| `ADMIN_TG_ID` | `7610842643` | Ваш Telegram ID |
| `SECRET_KEY` | `ваш_сгенерированный_ключ` | Тот же секретный ключ |
| `DATABASE_URL` | `${{MySQL.DATABASE_URL}}` | Ссылка на MySQL |
| `ADMIN_HOST` | `0.0.0.0` | Хост для привязки |
| `ADMIN_PORT` | `$PORT` | Порт (автоматически от Railway) |

**Опциональные переменные:**

| Переменная | Значение | Описание |
|-----------|----------|----------|
| `REDIS_URL` | `${{Redis.REDIS_URL}}` | Ссылка на Redis |
| `MARZBAN_API_URL` | `https://your-marzban.com` | URL Marzban (для статистики) |
| `MARZBAN_USERNAME` | `admin` | Логин Marzban |
| `MARZBAN_PASSWORD` | `your_password` | Пароль Marzban |

### 6.3 Получение публичного URL

Админ-панель должна быть доступна через интернет.

1. Перейдите в **Settings** → **Networking**
2. Нажмите **"Generate Domain"**
3. Railway создаст публичный URL, например:
   ```
   https://admin-panel-production-xxxx.up.railway.app
   ```
4. **Сохраните этот URL** - он понадобится для доступа к админ панели

### 6.4 Запуск админ-панели

1. После добавления переменных Railway автоматически запустит деплой
2. Перейдите во вкладку **"Deployments"**
3. Дождитесь статуса **"Success"**
4. Проверьте логи

Вы должны увидеть:
```
INFO - Application startup complete
INFO - Uvicorn running on http://0.0.0.0:XXXX
```

### 6.5 Проверка доступности

1. Откройте сгенерированный URL в браузере
2. Вы должны увидеть редирект на `/admin`
3. Должна открыться страница с дашбордом админ-панели

**Если страница не открывается:**
- Проверьте логи в Railway
- Убедитесь, что порт `$PORT` правильно настроен
- Проверьте, что сервис в статусе "Active"

---

## Шаг 7: Применение миграций базы данных

После развертывания всех сервисов нужно применить миграции для создания таблиц в базе данных.

### 7.1 Создание временного сервиса для миграций

1. В проекте нажмите **"+ New"**
2. Выберите **"GitHub Repo"**
3. Выберите репозиторий `yovpn-bot`

### 7.2 Настройка сервиса миграций

1. Переименуйте сервис в `migrations`
2. Перейдите в **Settings** → **Deploy**
3. В **"Custom Start Command"** введите:
   ```bash
   alembic upgrade head
   ```

### 7.3 Настройка переменных

Добавьте переменные:

| Переменная | Значение |
|-----------|----------|
| `DATABASE_URL` | `${{MySQL.DATABASE_URL}}` |

### 7.4 Запуск миграций

1. Railway автоматически запустит сервис
2. Миграции выполнятся один раз
3. Сервис завершит работу

**Проверка логов:**
```
INFO - Running upgrade -> head
INFO - Applying migration: create_users_table
INFO - Applying migration: create_subscriptions_table
INFO - Applying migration: create_transactions_table
SUCCESS - All migrations applied successfully
```

### 7.5 Удаление временного сервиса

После успешного применения миграций:
1. Перейдите в настройки сервиса `migrations`
2. Нажмите **"Delete Service"**
3. Подтвердите удаление

Миграции больше не нужны - они выполняются только один раз.

---

## Шаг 8: Проверка работоспособности

### 8.1 Проверка базы данных

1. Откройте сервис MySQL
2. Перейдите во вкладку **"Data"** (если доступно)
3. Или используйте Railway CLI:
   ```bash
   railway connect MySQL
   ```
4. Проверьте наличие таблиц:
   ```sql
   SHOW TABLES;
   ```

Вы должны увидеть:
```
+-------------------+
| Tables_in_railway |
+-------------------+
| users             |
| subscriptions     |
| transactions      |
| settings          |
+-------------------+
```

### 8.2 Проверка бота

1. Найдите вашего бота в Telegram
2. Отправьте команду `/start`
3. Бот должен ответить приветственным сообщением

**Ожидаемый ответ:**
```
🎉 Добро пожаловать в YoVPN!

На вашем балансе: 12.00 ₽
(3 дня бесплатного доступа)

Выберите действие:
[Кнопки меню]
```

### 8.3 Проверка админ-панели

1. Откройте URL админ-панели в браузере
2. Вы должны увидеть дашборд со статистикой
3. Проверьте основные разделы:
   - 📊 Статистика
   - 👥 Пользователи
   - 💰 Баланс
   - 🔧 Подписки

**Тест функциональности:**
1. Откройте раздел "Пользователи"
2. Найдите вашего пользователя (который отправил `/start`)
3. Проверьте баланс (должен быть 12.00 ₽)

### 8.4 Проверка Marzban интеграции

В Telegram боте:
1. Отправьте `/admin` (если вы администратор)
2. Выберите "⚙️ Настройки Marzban"
3. Нажмите "🔍 Проверить подключение"

Вы должны увидеть:
```
✅ Marzban API доступен
🌐 URL: https://your-marzban.com
📊 Пользователей: X
```

### 8.5 Тестирование полного цикла

**Шаг 1:** Активация VPN в боте
1. В боте выберите "🔐 Активировать VPN"
2. Выберите платформу (например, iOS)
3. Получите конфигурацию

**Шаг 2:** Проверка в админ-панели
1. Откройте админ панель
2. Перейдите в "Подписки"
3. Должна появиться новая активная подписка

**Шаг 3:** Проверка в Marzban
1. Откройте панель Marzban
2. Проверьте список пользователей
3. Должен появиться новый пользователь

---

## Настройка после развертывания

### 1. Настройка Menu Button в BotFather

Если вы используете WebApp:

1. Откройте [@BotFather](https://t.me/BotFather)
2. Отправьте `/mybots`
3. Выберите вашего бота
4. Выберите **"Bot Settings"** → **"Menu Button"**
5. Введите URL вашего WebApp (если есть)

### 2. Настройка команд бота

1. В BotFather выберите **"Edit Commands"**
2. Введите список команд:
   ```
   start - Запустить бота
   help - Помощь
   balance - Мой баланс
   subscription - Моя подписка
   referral - Реферальная программа
   support - Поддержка
   admin - Админ панель (только для администратора)
   ```

### 3. Настройка приватности

1. В BotFather выберите **"Bot Settings"** → **"Group Privacy"**
2. Выберите **"Disable"** (если бот не должен работать в группах)

### 4. Настройка изображения и описания

1. **Установка аватара:**
   - BotFather → выберите бота → "Edit Botpic"
   - Загрузите изображение 512x512 px

2. **Описание:**
   - BotFather → выберите бота → "Edit Description"
   - Введите описание (до 512 символов)

3. **Краткое описание:**
   - BotFather → выберите бота → "Edit About"
   - Введите краткое описание (до 120 символов)

### 5. Настройка custom domain (опционально)

Если вы хотите использовать собственный домен для админ-панели:

1. Купите домен (Namecheap, GoDaddy, Cloudflare и т.д.)
2. В Railway перейдите в настройки сервиса admin-panel
3. Settings → **Networking** → **Custom Domain**
4. Нажмите **"Add custom domain"**
5. Введите ваш домен, например: `admin.yourdomain.com`
6. Railway покажет CNAME запись для настройки
7. Добавьте CNAME запись в DNS вашего домена:
   ```
   Type: CNAME
   Name: admin
   Value: xxx.up.railway.app
   TTL: 3600
   ```
8. Дождитесь распространения DNS (до 24 часов)
9. Админ панель будет доступна по адресу `https://admin.yourdomain.com`

### 6. Настройка SSL сертификата

Railway автоматически предоставляет SSL сертификаты для всех доменов (включая кастомные). Никаких дополнительных действий не требуется.

### 7. Настройка уведомлений

Настройте уведомления в Railway для мониторинга:

1. Перейдите в **Project Settings** → **Notifications**
2. Добавьте Telegram webhook или email
3. Выберите типы уведомлений:
   - Deployment failures
   - Service crashes
   - Database issues

---

## Управление и мониторинг

### Просмотр логов

#### Railway Dashboard

1. Откройте сервис (bot или admin-panel)
2. Перейдите во вкладку **"Logs"**
3. Выберите временной период
4. Используйте поиск для фильтрации

#### Railway CLI

```bash
# Установка CLI
npm install -g @railway/cli

# Авторизация
railway login

# Подключение к проекту
railway link

# Просмотр логов бота
railway logs --service telegram-bot --tail

# Просмотр логов админ панели
railway logs --service admin-panel --tail
```

### Мониторинг ресурсов

1. Откройте проект в Railway
2. Каждый сервис показывает:
   - **CPU Usage** - использование процессора
   - **Memory Usage** - использование памяти
   - **Network** - входящий/исходящий трафик

### Метрики производительности

Railway предоставляет графики:
- CPU Usage Over Time
- Memory Usage Over Time
- Network Traffic

Доступ: Откройте сервис → вкладка **"Metrics"**

### Настройка алертов

Рекомендуется настроить внешний мониторинг:

#### UptimeRobot (бесплатно)

1. Зарегистрируйтесь на [uptimerobot.com](https://uptimerobot.com)
2. Создайте монитор:
   - Type: HTTP(s)
   - URL: `https://admin-panel-xxxx.up.railway.app/admin`
   - Monitoring Interval: 5 minutes
3. Добавьте контакты для уведомлений

#### BetterUptime (бесплатно)

1. Зарегистрируйтесь на [betteruptime.com](https://betteruptime.com)
2. Создайте монитор
3. Настройте уведомления в Telegram

---

## Обновление приложения

### Автоматическое обновление через GitHub

Railway автоматически обновляет приложение при push в репозиторий.

**Процесс обновления:**

1. Внесите изменения в код локально
2. Закоммитьте изменения:
   ```bash
   git add .
   git commit -m "Update: добавлена новая функция"
   git push origin main
   ```
3. Railway автоматически:
   - Обнаружит изменения в GitHub
   - Запустит новый деплой
   - Применит изменения без простоя

**Мониторинг обновления:**
1. Откройте Railway Dashboard
2. Перейдите во вкладку **"Deployments"**
3. Наблюдайте за процессом в реальном времени

### Ручное обновление

Если автоматическое обновление отключено:

1. Откройте нужный сервис в Railway
2. Перейдите в **"Deployments"**
3. Нажмите **"Deploy"** → **"Redeploy"**

### Откат к предыдущей версии

Если новая версия работает неправильно:

1. Откройте сервис → **"Deployments"**
2. Найдите успешный предыдущий деплой
3. Нажмите **"⋯"** → **"Redeploy"**

### Обновление зависимостей

При изменении `requirements.txt`:

1. Railway автоматически обнаружит изменения
2. Установит новые зависимости при деплое
3. Перезапустит сервис

### Миграции базы данных

При изменении моделей базы данных:

1. Создайте миграцию локально:
   ```bash
   alembic revision --autogenerate -m "Добавлена новая таблица"
   ```

2. Закоммитьте изменения:
   ```bash
   git add database/migrations/
   git commit -m "Database: новая миграция"
   git push
   ```

3. Примените миграцию через Railway CLI:
   ```bash
   railway run alembic upgrade head
   ```

**Или создайте временный сервис для миграций** (как в Шаге 7).

---

## Устранение неполадок

### Проблема: Бот не отвечает

**Симптомы:**
- Бот не реагирует на команды
- Команды остаются без ответа

**Решения:**

1. **Проверьте статус сервиса:**
   - Railway Dashboard → сервис `telegram-bot`
   - Статус должен быть **"Active"**

2. **Проверьте логи:**
   ```
   Railway Dashboard → telegram-bot → Logs
   ```
   Ищите ошибки подключения или исключения

3. **Проверьте переменные окружения:**
   - Убедитесь, что `TELEGRAM_BOT_TOKEN` правильный
   - Проверьте формат: `123456789:ABCdef...`

4. **Проверьте базу данных:**
   - Убедитесь, что MySQL сервис активен
   - Проверьте подключение: `DATABASE_URL` правильный

5. **Перезапуск:**
   - Deployments → Redeploy

### Проблема: Админ-панель не открывается

**Симптомы:**
- Ошибка 502 Bad Gateway
- Ошибка 503 Service Unavailable
- Страница не загружается

**Решения:**

1. **Проверьте статус сервиса:**
   - admin-panel → должен быть **"Active"**

2. **Проверьте порт:**
   - Variables → убедитесь, что `ADMIN_PORT=$PORT`
   - Start Command: должен содержать `--port $PORT`

3. **Проверьте логи:**
   ```
   Railway Dashboard → admin-panel → Logs
   ```
   Ищите ошибки запуска uvicorn

4. **Проверьте публичный URL:**
   - Settings → Networking
   - Убедитесь, что домен сгенерирован

5. **Проверьте базу данных:**
   - admin-panel должен иметь доступ к `DATABASE_URL`

### Проблема: Ошибка подключения к базе данных

**Симптомы:**
- `Connection refused`
- `Unknown database`
- `Access denied`

**Решения:**

1. **Проверьте формат DATABASE_URL:**
   ```
   mysql+aiomysql://user:password@host:port/database
   ```

2. **Проверьте ссылку на MySQL:**
   - Должно быть: `${{MySQL.DATABASE_URL}}`
   - Не должно быть хардкода

3. **Проверьте статус MySQL:**
   - MySQL сервис должен быть **"Active"**

4. **Проверьте миграции:**
   - Возможно, миграции не были применены
   - Выполните: `railway run alembic upgrade head`

5. **Проверьте логи MySQL:**
   - MySQL → Logs
   - Ищите ошибки подключения

### Проблема: Ошибка подключения к Marzban API

**Симптомы:**
- `Marzban API недоступен`
- `Connection timeout`
- `401 Unauthorized`

**Решения:**

1. **Проверьте URL Marzban:**
   - Формат: `https://marzban.example.com`
   - Без trailing slash
   - С протоколом `https://` или `http://`

2. **Проверьте токен или username/password:**
   - Token: `MARZBAN_API_TOKEN` должен быть валидным JWT
   - Или используйте `MARZBAN_USERNAME` и `MARZBAN_PASSWORD`

3. **Проверьте доступность Marzban:**
   - Откройте URL Marzban в браузере
   - Убедитесь, что сервер доступен из интернета

4. **Проверьте firewall:**
   - Railway IP может быть заблокирован
   - Добавьте Railway в whitelist

5. **Проверьте сертификат SSL:**
   - Если используется self-signed сертификат, может быть ошибка

### Проблема: Высокое использование памяти

**Симптомы:**
- Сервис перезапускается
- Out of Memory (OOM) ошибки

**Решения:**

1. **Проверьте метрики:**
   - Service → Metrics → Memory Usage
   - Hobby Plan: 512MB RAM

2. **Оптимизация:**
   - Используйте Redis для кэширования
   - Уменьшите количество одновременных запросов

3. **Upgrade плана:**
   - Перейдите на Developer Plan ($5/месяц)
   - Получите 8GB RAM на сервис

### Проблема: Деплой падает с ошибкой

**Симптомы:**
- Build Failed
- Deploy Failed

**Решения:**

1. **Проверьте логи деплоя:**
   - Deployments → Failed → View Logs
   - Ищите ошибки установки зависимостей

2. **Проверьте requirements.txt:**
   - Убедитесь, что все зависимости указаны
   - Проверьте версии пакетов

3. **Проверьте Dockerfile:**
   - Если используется Docker
   - Проверьте корректность команд

4. **Проверьте Start Command:**
   - Должен быть правильный путь к файлу
   - Должен использовать правильный Python

### Проблема: CORS ошибки

**Симптомы:**
- Browser console показывает CORS ошибки
- WebApp не может подключиться к API

**Решения:**

1. **Настройте CORS в admin-panel:**
   - Добавьте переменную `CORS_ORIGINS`
   - Значение: URL вашего WebApp или `*`

2. **Проверьте код:**
   - В `admin/main.py` должна быть настройка CORS:
   ```python
   from fastapi.middleware.cors import CORSMiddleware
   app.add_middleware(
       CORSMiddleware,
       allow_origins=["*"],
       allow_credentials=True,
       allow_methods=["*"],
       allow_headers=["*"],
   )
   ```

---

## Безопасность

### Лучшие практики

#### 1. Защита токенов

- ✅ **НЕ КОММИТЬТЕ** токены в Git
- ✅ Используйте переменные окружения Railway
- ✅ Регулярно обновляйте токены

#### 2. Ограничение доступа к админ-панели

- ✅ Используйте сильные пароли
- ✅ Ограничьте доступ по IP (если возможно)
- ✅ Включите 2FA для GitHub аккаунта

#### 3. Мониторинг безопасности

- ✅ Регулярно проверяйте логи на подозрительную активность
- ✅ Настройте алерты для неудачных попыток входа
- ✅ Отслеживайте изменения в коде

#### 4. Обновление зависимостей

- ✅ Регулярно обновляйте Python пакеты
- ✅ Проверяйте уязвимости с помощью `pip-audit`
- ✅ Следите за security advisory

#### 5. Резервное копирование

- ✅ Регулярно делайте бэкапы базы данных
- ✅ Храните бэкапы в безопасном месте
- ✅ Тестируйте восстановление из бэкапов

### Настройка бэкапов базы данных

Railway не предоставляет автоматические бэкапы на бесплатном плане.

**Ручной бэкап через Railway CLI:**

```bash
# Подключение к MySQL
railway connect MySQL

# Экспорт базы данных
mysqldump -h host -u user -p database > backup.sql

# Или через Railway CLI
railway run mysqldump railway > backup_$(date +%Y%m%d).sql
```

**Автоматизация бэкапов:**

Создайте GitHub Action для автоматических бэкапов:

```yaml
# .github/workflows/backup.yml
name: Database Backup

on:
  schedule:
    - cron: '0 2 * * *'  # Каждый день в 2:00 UTC

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Backup database
        run: |
          # Ваш скрипт бэкапа
          echo "Creating backup..."
```

### Мониторинг безопасности

Рекомендуется использовать:

1. **Sentry** - для отслеживания ошибок
   - Регистрация: [sentry.io](https://sentry.io)
   - Интеграция с Railway

2. **LogDNA / Logtail** - для централизованного логирования
   - Больше возможностей анализа логов
   - Алерты и уведомления

---

## Стоимость и оптимизация

### Railway Pricing

#### Hobby Plan (Бесплатно)
- **$5 кредитов** в месяц
- **512MB RAM** на сервис
- **1GB Disk** на сервис
- **100GB Bandwidth** исходящего трафика

**Примерная стоимость сервисов:**
- MySQL: ~$1-2 в месяц
- Redis: ~$0.5-1 в месяц
- Telegram Bot: ~$1-2 в месяц
- Admin Panel: ~$1-2 в месяц

**Итого:** ~$4-7 в месяц (может уложиться в бесплатные $5)

#### Developer Plan ($5/месяц + использование)
- **$5 кредитов включено**
- **8GB RAM** на сервис
- **100GB Disk** на сервис
- **Priority CPU**

### Оптимизация затрат

#### 1. Используйте Redis эффективно

Redis кэширует данные и снижает нагрузку на MySQL:
- Кэшируйте статистику
- Кэшируйте данные пользователей
- Установите TTL для кэша

#### 2. Оптимизация запросов к БД

- Используйте индексы
- Избегайте N+1 запросов
- Используйте batch операции

#### 3. Мониторинг использования

Регулярно проверяйте:
- Railway Dashboard → Project → Usage
- Анализируйте, какой сервис потребляет больше ресурсов

#### 4. Отключение неиспользуемых сервисов

Если сервис не используется:
- Service → Settings → Sleep when inactive
- Или временно удалите сервис

### Прогнозирование затрат

**Для малого бота (до 100 пользователей):**
- Hobby Plan ($5 бесплатно) - достаточно

**Для среднего бота (100-1000 пользователей):**
- Developer Plan ($5/месяц) + $5-10 использования = $10-15/месяц

**Для большого бота (1000+ пользователей):**
- Team Plan или выше
- Рекомендуется миграция на VPS

---

## Дополнительные ресурсы

### Документация

- [Railway Documentation](https://docs.railway.app/)
- [Railway CLI](https://docs.railway.app/develop/cli)
- [aiogram Documentation](https://docs.aiogram.dev/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Marzban Documentation](https://github.com/Gozargah/Marzban)

### Полезные ссылки

- [Railway Status](https://railway.app/status) - статус платформы
- [Railway Discord](https://discord.gg/railway) - сообщество Railway
- [Railway Twitter](https://twitter.com/Railway) - новости и обновления

### Поддержка проекта

- **GitHub Issues:** [github.com/yourusername/yovpn-bot/issues](https://github.com/yourusername/yovpn-bot/issues)
- **Telegram Support:** [@YoVPNSupport](https://t.me/YoVPNSupport)
- **Documentation:** [Смотрите файлы README в репозитории]

---

## Чеклист финальной проверки

Перед запуском в production убедитесь:

### База данных
- [ ] MySQL сервис активен и доступен
- [ ] Миграции применены успешно
- [ ] Таблицы созданы (users, subscriptions, transactions, settings)
- [ ] Redis работает (если используется)

### Telegram Bot
- [ ] Бот отвечает на команду `/start`
- [ ] Приветственный бонус начисляется
- [ ] Реферальная система работает
- [ ] Активация VPN функционирует
- [ ] Подключение к Marzban установлено

### Админ-панель
- [ ] Админ панель доступна через URL
- [ ] Дашборд отображает статистику
- [ ] Управление пользователями работает
- [ ] Управление балансом работает
- [ ] Рассылки функционируют

### Безопасность
- [ ] Все токены и пароли в переменных окружения
- [ ] Админ панель доступна только администратору
- [ ] SSL сертификаты настроены
- [ ] Логирование включено

### Мониторинг
- [ ] Логи доступны и читаемы
- [ ] Метрики отслеживаются
- [ ] Алерты настроены (опционально)
- [ ] Uptime мониторинг настроен (опционально)

### Производительность
- [ ] Использование памяти в норме
- [ ] Использование CPU в норме
- [ ] Время отклика приемлемое
- [ ] База данных оптимизирована

---

## Заключение

Поздравляем! 🎉

Вы успешно развернули полнофункциональный VPN бот с админ-панелью на Railway.

**Что дальше:**

1. **Настройте оплату** - интегрируйте платежную систему
2. **Добавьте функции** - расширьте функциональность бота
3. **Масштабируйте** - при росте пользователей переходите на более мощные планы
4. **Мониторьте** - следите за работой системы и реагируйте на проблемы
5. **Улучшайте** - собирайте обратную связь и улучшайте UX

**Полезные команды:**

```bash
# Просмотр логов
railway logs

# Подключение к базе данных
railway connect MySQL

# Выполнение команд
railway run python manage.py

# Статус проекта
railway status
```

**Поддержка:**

Если у вас возникли вопросы или проблемы:
- Проверьте раздел [Устранение неполадок](#устранение-неполадок)
- Посмотрите документацию Railway
- Создайте issue на GitHub
- Свяжитесь с поддержкой в Telegram

---

**Создано с ❤️ для YoVPN Bot**

*Последнее обновление: 24 октября 2025*
